---
description: Guidelines for implementing utility functions
globs: scripts/modules/utils.js, mcp-server/src/**/*
alwaysApply: false
---
ä»¥ä¸‹æ˜¯ç¿»è¯‘åçš„ Markdown æ ¼å¼æ–‡æ¡£å†…å®¹ï¼š

# å®ç”¨å‡½æ•°æŒ‡å—

## åŸºæœ¬åŸåˆ™

- **å‡½æ•°èŒƒå›´**ï¼š
  - âœ… **åº”è¯¥**ï¼šåˆ›å»ºæœåŠ¡äºå¤šä¸ªæ¨¡å—çš„å®ç”¨å‡½æ•°ã€‚
  - âœ… **åº”è¯¥**ï¼šä¿æŒå‡½æ•°å•ä¸€ç”¨é€”ä¸”ä¸“æ³¨ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šåœ¨å®ç”¨å‡½æ•°ä¸­åŒ…å«ä¸šåŠ¡é€»è¾‘ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šåˆ›å»ºå…·æœ‰å‰¯ä½œç”¨çš„å®ç”¨å‡½æ•°ã€‚

  ```javascript
  // âœ… **åº”è¯¥**ï¼šåˆ›å»ºä¸“æ³¨ä¸”å¯å¤ç”¨çš„å®ç”¨å‡½æ•°
  /**
   * æˆªæ–­æ–‡æœ¬åˆ°æŒ‡å®šé•¿åº¦
   * @param {string} text - è¦æˆªæ–­çš„æ–‡æœ¬
   * @param {number} maxLength - æœ€å¤§é•¿åº¦
   * @returns {string} æˆªæ–­åçš„æ–‡æœ¬
   */
  function truncate(text, maxLength) {
    if (!text || text.length <= maxLength) {
      return text;
    }
    return text.slice(0, maxLength - 3) + '...';
  }
  ```

  ```javascript
  // âŒ **ä¸åº”è¯¥**ï¼šåœ¨å®ç”¨å‡½æ•°ä¸­æ·»åŠ å‰¯ä½œç”¨
  function truncate(text, maxLength) {
    if (!text || text.length <= maxLength) {
      return text;
    }
    
    // å‰¯ä½œç”¨ - ä¿®æ”¹å…¨å±€çŠ¶æ€æˆ–æ—¥å¿—è®°å½•
    console.log(`å°†æ–‡æœ¬ä» ${text.length} æˆªæ–­åˆ° ${maxLength} ä¸ªå­—ç¬¦`);
    
    return text.slice(0, maxLength - 3) + '...';
  }
  ```

- **ä½ç½®**ï¼š
    - **æ ¸å¿ƒ CLI å®ç”¨å·¥å…·**ï¼šå°†ä¸»è¦ç”¨äºæ ¸å¿ƒ `task-master` CLI é€»è¾‘å’Œå‘½ä»¤æ¨¡å— (`scripts/modules/*`) çš„å®ç”¨å·¥å…·æ”¾å…¥ [scripts/modules/utils.js](mdc:scripts/modules/utils.js)ã€‚
    - **MCP æœåŠ¡å™¨å®ç”¨å·¥å…·**ï¼šå°†ä¸“é—¨è®¾è®¡ç”¨äºæ”¯æŒ MCP æœåŠ¡å™¨å®ç°çš„å®ç”¨å·¥å…·æ”¾å…¥ `mcp-server/src/` çš„é€‚å½“å­ç›®å½•ä¸­ã€‚
        - è·¯å¾„/æ ¸å¿ƒé€»è¾‘è¾…åŠ©å·¥å…·ï¼š[mcp-server/src/core/utils/](mdc:mcp-server/src/core/utils/)ï¼ˆä¾‹å¦‚ `path-utils.js`ï¼‰ã€‚
        - å·¥å…·æ‰§è¡Œ/å“åº”è¾…åŠ©å·¥å…·ï¼š[mcp-server/src/tools/utils.js](mdc:mcp-server/src/tools/utils.js)ã€‚

## æ–‡æ¡£æ ‡å‡†

- **JSDoc æ ¼å¼**ï¼š
  - âœ… **åº”è¯¥**ï¼šä¸ºæ‰€æœ‰å‚æ•°å’Œè¿”å›å€¼æ·»åŠ æ–‡æ¡£ã€‚
  - âœ… **åº”è¯¥**ï¼šä¸ºå¤æ‚é€»è¾‘æ·»åŠ æè¿°ã€‚
  - âœ… **åº”è¯¥**ï¼šä¸ºéæ˜¾è€Œæ˜“è§çš„ç”¨æ³•æ·»åŠ ç¤ºä¾‹ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šè·³è¿‡â€œç®€å•â€å‡½æ•°çš„æ–‡æ¡£ã€‚

  ```javascript
  // âœ… **åº”è¯¥**ï¼šæä¾›å®Œæ•´çš„ JSDoc æ–‡æ¡£
  /**
   * è¯»å–å¹¶è§£æ JSON æ–‡ä»¶
   * @param {string} filepath - JSON æ–‡ä»¶è·¯å¾„
   * @returns {Object|null} è§£æåçš„ JSON æ•°æ®ï¼Œæˆ–åœ¨å‘ç”Ÿé”™è¯¯æ—¶è¿”å› null
   */
  function readJSON(filepath) {
    try {
      const rawData = fs.readFileSync(filepath, 'utf8');
      return JSON.parse(rawData);
    } catch (error) {
      log('error', `è¯»å– JSON æ–‡ä»¶ ${filepath} æ—¶å‡ºé”™ï¼š`, error.message);
      if (CONFIG.debug) {
        console.error(error);
      }
      return null;
    }
  }
  ```

## é…ç½®ç®¡ç†ï¼ˆé€šè¿‡ `config-manager.js`ï¼‰

Taskmaster é…ç½®ï¼ˆä¸åŒ…æ‹¬ API å¯†é’¥ï¼‰ä¸»è¦é€šè¿‡ä½äºé¡¹ç›®æ ¹ç›®å½•çš„ `.taskmasterconfig` æ–‡ä»¶è¿›è¡Œç®¡ç†ï¼Œå¹¶é€šè¿‡ [scripts/modules/config-manager.js](mdc:scripts/modules/config-manager.js) ä¸­çš„ getter è®¿é—®ã€‚

- **`.taskmasterconfig` æ–‡ä»¶**ï¼š
  - âœ… **åº”è¯¥**ï¼šä½¿ç”¨æ­¤ JSON æ–‡ä»¶å­˜å‚¨è®¾ç½®ï¼Œå¦‚ AI æ¨¡å‹é€‰æ‹©ï¼ˆä¸»æ¨¡å‹ã€ç ”ç©¶æ¨¡å‹ã€å¤‡ç”¨æ¨¡å‹ï¼‰ã€å‚æ•°ï¼ˆæ¸©åº¦ã€æœ€å¤§ä»¤ç‰Œæ•°ï¼‰ã€æ—¥å¿—çº§åˆ«ã€é»˜è®¤ä¼˜å…ˆçº§/å­ä»»åŠ¡ç­‰ã€‚
  - âœ… **åº”è¯¥**ï¼šä½¿ç”¨ `task-master models --setup` CLI å‘½ä»¤æˆ– `models` MCP å·¥å…·ç®¡ç†æ­¤æ–‡ä»¶ã€‚
  - âœ… **åº”è¯¥**ï¼šä¾èµ– [config-manager.js](mdc:scripts/modules/config-manager.js) åŠ è½½æ­¤æ–‡ä»¶ï¼ˆä½¿ç”¨ä» MCP æˆ–é€šè¿‡ CLI å·¥å…·æ‰¾åˆ°çš„æ­£ç¡®é¡¹ç›®æ ¹ç›®å½•ï¼‰ï¼Œä¸é»˜è®¤å€¼åˆå¹¶ï¼Œå¹¶æä¾›ç»è¿‡éªŒè¯çš„è®¾ç½®ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šåœ¨æ­¤æ–‡ä»¶ä¸­å­˜å‚¨ API å¯†é’¥ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šé™¤éå¿…è¦ï¼Œå¦åˆ™ä¸è¦æ‰‹åŠ¨ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚

- **é…ç½® getterï¼ˆ`config-manager.js`ï¼‰**ï¼š
  - âœ… **åº”è¯¥**ï¼šä» `config-manager.js` å¯¼å…¥å¹¶ä½¿ç”¨ç‰¹å®šçš„ getterï¼ˆä¾‹å¦‚ `getMainProvider()`ã€`getLogLevel()`ã€`getMainMaxTokens()`ï¼‰æ¥è®¿é—® *åº”ç”¨é€»è¾‘æ‰€éœ€* çš„é…ç½®å€¼ï¼ˆå¦‚ `getDefaultSubtasks`ï¼‰ã€‚
  - âœ… **åº”è¯¥**ï¼šå¦‚æœä» MCP ç›´æ¥å‡½æ•°è°ƒç”¨ getterï¼Œåˆ™ä¼ é€’ `explicitRoot` å‚æ•°ï¼Œä»¥ç¡®ä¿åŠ è½½æ­£ç¡®é¡¹ç›®çš„é…ç½®ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šä»æ ¸å¿ƒé€»è¾‘å‡½æ•°ï¼ˆ`scripts/modules/task-manager/*`ï¼‰è°ƒç”¨ AI ç‰¹å®šçš„ getterï¼ˆå¦‚ `getMainModelId`ã€`getMainMaxTokens`ï¼‰ã€‚ç›¸åï¼Œåº”å°† `role` ä¼ é€’ç»™ç»Ÿä¸€çš„ AI æœåŠ¡ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šç›´æ¥ä»ç¯å¢ƒå˜é‡è®¿é—®é…ç½®å€¼ï¼ˆé™¤äº† API å¯†é’¥ï¼‰ã€‚

- **API å¯†é’¥å¤„ç†ï¼ˆ`utils.js` & `ai-services-unified.js`ï¼‰**ï¼š
  - âœ… **åº”è¯¥**ï¼šä»…åœ¨ `.env`ï¼ˆç”± CLI ä½¿ç”¨ï¼Œé€šè¿‡ `scripts/dev.js` ä¸­çš„ `dotenv` åŠ è½½ï¼‰æˆ– `.cursor/mcp.json`ï¼ˆç”± MCP ä½¿ç”¨ï¼Œé€šè¿‡ `session.env` è®¿é—®ï¼‰ä¸­å­˜å‚¨ API å¯†é’¥ã€‚
  - âœ… **åº”è¯¥**ï¼šåœ¨å¯èƒ½éœ€è¦å°è¯• AI è°ƒç”¨ä¹‹å‰ï¼Œä½¿ç”¨ `isApiKeySet(providerName, session)` ä» `config-manager.js` æ£€æŸ¥æä¾›å•†çš„å¯†é’¥æ˜¯å¦å¯ç”¨ï¼Œä½†è¯·æ³¨æ„ç»Ÿä¸€æœåŠ¡ä¼šæ‰§è¡Œè‡ªå·±çš„å†…éƒ¨æ£€æŸ¥ã€‚
  - âœ… **åº”è¯¥**ï¼šäº†è§£ç»Ÿä¸€æœåŠ¡å±‚ï¼ˆ`ai-services-unified.js`ï¼‰å†…éƒ¨ä½¿ç”¨ `resolveEnvVariable(key, session)` ä» `utils.js` è§£æ API å¯†é’¥ã€‚

- **é”™è¯¯å¤„ç†**ï¼š
  - âœ… **åº”è¯¥**ï¼šå¦‚æœ `.taskmasterconfig` æ–‡ä»¶ç¼ºå¤±æˆ–æ— æ•ˆï¼Œå½“é€šè¿‡ `getConfig` è®¿é—®æ—¶ï¼ˆä¾‹å¦‚åœ¨ `commands.js` æˆ–ç›´æ¥å‡½æ•°ä¸­ï¼‰ï¼Œå¤„ç†æ½œåœ¨çš„ `ConfigurationError`ã€‚

## æ—¥å¿—å®ç”¨å·¥å…·ï¼ˆåœ¨ `scripts/modules/utils.js` ä¸­ï¼‰

- **æ—¥å¿—çº§åˆ«**ï¼š
  - âœ… **åº”è¯¥**ï¼šæ”¯æŒå¤šä¸ªæ—¥å¿—çº§åˆ«ï¼ˆè°ƒè¯•ã€ä¿¡æ¯ã€è­¦å‘Šã€é”™è¯¯ï¼‰ã€‚
  - âœ… **åº”è¯¥**ï¼šä¸ºä¸åŒæ—¥å¿—çº§åˆ«ä½¿ç”¨é€‚å½“çš„å›¾æ ‡ã€‚
  - âœ… **åº”è¯¥**ï¼šå°Šé‡é…ç½®çš„æ—¥å¿—çº§åˆ«ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šåœ¨æ—¥å¿—å®ç”¨å·¥å…·ä¹‹å¤–ç›´æ¥ä½¿ç”¨ `console.log`ã€‚
  - **å…³äºä¼ é€’çš„æ—¥å¿—è®°å½•å™¨**ï¼šå½“å°†æ—¥å¿—è®°å½•å™¨å¯¹è±¡ï¼ˆå¦‚ FastMCP çš„ `log` å¯¹è±¡ï¼‰ä½œä¸º *å‚æ•°*ï¼ˆä¾‹å¦‚ä½œä¸º `mcpLog`ï¼‰ä¼ é€’åˆ°æ ¸å¿ƒ Task Master å‡½æ•°æ—¶ï¼Œæ¥æ”¶å‡½æ•°é€šå¸¸æœŸæœ›è¯¥å¯¹è±¡ä¸Šå¯ä»¥ç›´æ¥è°ƒç”¨ç‰¹å®šæ–¹æ³•ï¼ˆ`.info`ã€`.warn`ã€`.error` ç­‰ï¼‰ï¼ˆä¾‹å¦‚ `mcpLog[level](...)`ï¼‰ã€‚å¦‚æœä¼ é€’çš„æ—¥å¿—è®°å½•å™¨æ²¡æœ‰è¿™ç§ç¡®åˆ‡ç»“æ„ï¼Œåˆ™å¯èƒ½éœ€è¦åŒ…è£…å¯¹è±¡ã€‚æœ‰å…³æ ‡å‡†æ¨¡å¼ï¼Œè¯·å‚é˜… [mcp.mdc](mdc:.cursor/rules/mcp.mdc) ä¸­çš„ **å¤„ç†æ—¥å¿—ä¸Šä¸‹æ–‡ï¼ˆ`mcpLog`ï¼‰** éƒ¨åˆ†ã€‚

- **æ—¥å¿—è®°å½•å™¨åŒ…è£…æ¨¡å¼**ï¼š 
  - âœ… **åº”è¯¥**ï¼šä½¿ç”¨æ—¥å¿—è®°å½•å™¨åŒ…è£…æ¨¡å¼ä¼ é€’æ—¥å¿—è®°å½•å™¨ï¼Œä»¥é˜²æ­¢å‡ºç° `mcpLog[level] is not a function` é”™è¯¯ï¼š
  ```javascript
  // æ ‡å‡† logWrapper æ¨¡å¼ï¼Œç”¨äºåŒ…è£… FastMCP çš„ log å¯¹è±¡
  const logWrapper = {
    info: (message, ...args) => log.info(message, ...args),
    warn: (message, ...args) => log.warn(message, ...args),
    error: (message, ...args) => log.error(message, ...args),
    debug: (message, ...args) => log.debug && log.debug(message, ...args),
    success: (message, ...args) => log.info(message, ...args) // å°† success æ˜ å°„åˆ° info
  };
  
  // å°†æ­¤åŒ…è£…å™¨ä½œä¸º mcpLog ä¼ é€’ï¼Œä»¥ç¡®ä¿ä¸€è‡´çš„æ–¹æ³•å¯ç”¨æ€§
  // è¿™è¿˜ç¡®ä¿äº†è®¸å¤šæ ¸å¿ƒå‡½æ•°çš„è¾“å‡ºæ ¼å¼è®¾ç½®ä¸º 'json'
  const options = { mcpLog: logWrapper, session };
  ```
  - âœ… **åº”è¯¥**ï¼šåœ¨ä»»ä½•è°ƒç”¨æ ¸å¿ƒå‡½æ•°ï¼ˆæœŸæœ› `mcpLog`ï¼‰çš„ç›´æ¥å‡½æ•°ä¸­å®ç°æ­¤æ¨¡å¼ã€‚
  - âœ… **åº”è¯¥**ï¼šå°†æ­¤è§£å†³æ–¹æ¡ˆä¸é™é»˜æ¨¡å¼ç»“åˆä½¿ç”¨ï¼Œä»¥å®ç°å®Œæ•´çš„è¾“å‡ºæ§åˆ¶ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šç›´æ¥å°† FastMCP çš„ `log` å¯¹è±¡ä½œä¸º `mcpLog` ä¼ é€’ç»™æ ¸å¿ƒå‡½æ•°ã€‚
  - **é‡è¦**ï¼šæ­¤æ¨¡å¼å·²æˆåŠŸè§£å†³äº† MCP å·¥å…·ï¼ˆä¾‹å¦‚ `update-task`ã€`update-subtask`ï¼‰ä¸­çš„å¤šä¸ªé—®é¢˜ï¼Œå…¶ä¸­é”™è¯¯ä½¿ç”¨æˆ–çœç•¥ `mcpLog` å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯æˆ– JSON è§£æå¤±è´¥ã€‚
  - æœ‰å…³å®Œæ•´å®ç°ç»†èŠ‚ï¼Œè¯·å‚é˜… [mcp.mdc](mdc:.cursor/rules/mcp.mdc) ä¸­çš„ **å¤„ç†æ—¥å¿—ä¸Šä¸‹æ–‡ï¼ˆ`mcpLog`ï¼‰** éƒ¨åˆ†ã€‚

  ```javascript
  // âœ… **åº”è¯¥**ï¼šå®ç°é€‚å½“çš„æ—¥å¿—å®ç”¨å·¥å…·
  const LOG_LEVELS = {
    debug: 0,
    info: 1,
    warn: 2,
    error: 3
  };
  
  function log(level, ...args) {
    const icons = {
      debug: chalk.gray('ğŸ”'),
      info: chalk.blue('â„¹ï¸'),
      warn: chalk.yellow('âš ï¸'),
      error: chalk.red('âŒ'),
      success: chalk.green('âœ…')
    };
    
    if (LOG_LEVELS[level] >= LOG_LEVELS[CONFIG.logLevel]) {
      const icon = icons[level] || '';
      console.log(`${icon} ${args.join(' ')}`);
    }
  }
  ```

## é™é»˜æ¨¡å¼å®ç”¨å·¥å…·ï¼ˆåœ¨ `scripts/modules/utils.js` ä¸­ï¼‰

- **é™é»˜æ¨¡å¼æ§åˆ¶**ï¼š
  - âœ… **åº”è¯¥**ï¼šä½¿ç”¨å¯¼å‡ºçš„é™é»˜æ¨¡å¼å‡½æ•°ï¼Œè€Œä¸æ˜¯ç›´æ¥è®¿é—®å…¨å±€å˜é‡ã€‚
  - âœ… **åº”è¯¥**ï¼šå§‹ç»ˆä½¿ç”¨ `isSilentMode()` æ£€æŸ¥å½“å‰é™é»˜æ¨¡å¼çŠ¶æ€ã€‚
  - âœ… **åº”è¯¥**ï¼šåœ¨ `finally` å—ä¸­ç¦ç”¨é™é»˜æ¨¡å¼ï¼Œä»¥é˜²æ­¢å…¶ä¿æŒå¯ç”¨çŠ¶æ€ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šç›´æ¥è®¿é—®å…¨å±€ `silentMode` å˜é‡ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šå¯ç”¨é™é»˜æ¨¡å¼åå¿˜è®°ç¦ç”¨å®ƒã€‚

  ```javascript
  // âœ… **åº”è¯¥**ï¼šæ­£ç¡®ä½¿ç”¨é™é»˜æ¨¡å¼æ§åˆ¶å‡½æ•°
  
  // ç¤ºä¾‹ï¼šutils.js ä¸­çš„æ­£ç¡®å®ç°
  
  // å…¨å±€é™é»˜æ¨¡å¼æ ‡å¿—ï¼ˆæ¨¡å—ç§æœ‰ï¼‰
  let silentMode = false;
  
  // å¯ç”¨é™é»˜æ¨¡å¼
  function enableSilentMode() {
    silentMode = true;
  }
  
  // ç¦ç”¨é™é»˜æ¨¡å¼
  function disableSilentMode() {
    silentMode = false;
  }
  
  // æ£€æŸ¥é™é»˜æ¨¡å¼æ˜¯å¦å¯ç”¨
  function isSilentMode() {
    return silentMode;
  }
  
  // ç¤ºä¾‹ï¼šå¦ä¸€ä¸ªæ¨¡å—ä¸­çš„æ­£ç¡®ä½¿ç”¨
  import { enableSilentMode, disableSilentMode, isSilentMode } from './utils.js';
  
  // æ£€æŸ¥å½“å‰çŠ¶æ€
  if (!isSilentMode()) {
    console.log('é™é»˜æ¨¡å¼æœªå¯ç”¨');
  }
  
  // ä½¿ç”¨ try/finally æ¨¡å¼ç¡®ä¿ç¦ç”¨é™é»˜æ¨¡å¼
  try {
    enableSilentMode();
    // æ‰§è¡Œåº”æŠ‘åˆ¶æ§åˆ¶å°è¾“å‡ºçš„æ“ä½œ
    performOperation();
  } finally {
    disableSilentMode();
  }
  ```

- **ä¸æ—¥å¿—é›†æˆ**ï¼š
  - âœ… **åº”è¯¥**ï¼šä½¿ `log` å‡½æ•°å°Šé‡é™é»˜æ¨¡å¼
  ```javascript
  function log(level, ...args) {
    // å¦‚æœå¯ç”¨äº†é™é»˜æ¨¡å¼ï¼Œåˆ™è·³è¿‡æ—¥å¿—è®°å½•
    if (isSilentMode()) {
      return;
    }
    
    // å…¶ä½™æ—¥å¿—è®°å½•é€»è¾‘...
  }
  ```

- **é™é»˜æ¨¡å¼çš„å¸¸è§æ¨¡å¼**ï¼š
  - âœ… **åº”è¯¥**ï¼šåœ¨è°ƒç”¨ **æ ¸å¿ƒå‡½æ•°**ï¼ˆ`scripts/modules/*`ï¼‰çš„ **ç›´æ¥å‡½æ•°**ï¼ˆ`mcp-server/src/core/direct-functions/*`ï¼‰ä¸­ï¼Œç¡®ä¿æŠ‘åˆ¶æ ¸å¿ƒå‡½æ•°çš„æ§åˆ¶å°è¾“å‡ºï¼Œä»¥é¿å…ç ´å MCP JSON å“åº”ã€‚
    - **é¦–é€‰æ–¹æ³•**ï¼šæ›´æ–°æ ¸å¿ƒå‡½æ•°ä»¥æ¥å— `outputFormat` å‚æ•°ï¼ˆä¾‹å¦‚ `outputFormat = 'text'`ï¼‰ï¼Œå¹¶åœ¨æ˜¾ç¤ºä»»ä½• UI å…ƒç´ ï¼ˆæ¨ªå¹…ã€æ—‹è½¬å™¨ã€æ¡†ã€ç›´æ¥ `console.log`ï¼‰ä¹‹å‰æ£€æŸ¥ `outputFormat === 'text'`ã€‚ä»ç›´æ¥å‡½æ•°ä¼ é€’ `'json'`ã€‚
    - **å¿…è¦çš„å›é€€/ä¿è¯**ï¼šå¦‚æœæ ¸å¿ƒå‡½æ•° *ä¸èƒ½* è¢«ä¿®æ”¹ï¼Œæˆ–è€…å…¶é€šè¿‡ `outputFormat` æŠ‘åˆ¶è¾“å‡ºä¸å¯é ï¼Œåˆ™åœ¨ç›´æ¥å‡½æ•°ä¸­ä½¿ç”¨ `enableSilentMode()` å’Œ `disableSilentMode()` åŒ…è£…æ ¸å¿ƒå‡½æ•°è°ƒç”¨ï¼Œæ”¾åœ¨ `try/finally` å—ä¸­ã€‚è¿™ç›¸å½“äºä¸€ä¸ªå®‰å…¨ç½‘ã€‚
  ```javascript
  // ç¤ºä¾‹ï¼šç›´æ¥å‡½æ•°ä¸­çš„å®ç°
  export async function someOperationDirect(args, log) {
    let result;
    const tasksPath = findTasksJsonPath(args, log); // é¦–å…ˆè·å–è·¯å¾„
    
    // é€‰é¡¹ 1ï¼šæ ¸å¿ƒå‡½æ•°å¤„ç† 'json' æ ¼å¼ï¼ˆé¦–é€‰ï¼‰
    try {
      result = await coreFunction(tasksPath, ...otherArgs, 'json'); // ä¼ é€’ 'json'
      return { success: true, data: result, fromCache: false };
    } catch (error) {
      // å¤„ç†é”™è¯¯...
    }

    // é€‰é¡¹ 2ï¼šæ ¸å¿ƒå‡½æ•°è¾“å‡ºä¸å¯é ï¼ˆå›é€€/ä¿è¯ï¼‰
    try {
      enableSilentMode(); // åœ¨è°ƒç”¨å‰å¯ç”¨
      result = await coreFunction(tasksPath, ...otherArgs); // è°ƒç”¨æ—¶ä¸ä¼ é€’æ ¼å¼å‚æ•°
    } catch (error) {
      // å¤„ç†é”™è¯¯...
      log.error(`å¤±è´¥ï¼š${error.message}`);
      return { success: false, error: { /* ... */ } };
    } finally {
      disableSilentMode(); // å§‹ç»ˆåœ¨ finally ä¸­ç¦ç”¨
    }
    return { success: true, data: result, fromCache: false }; // å‡è®¾å¦‚æœæ²¡æœ‰æ•è·é”™è¯¯åˆ™æˆåŠŸ
  }
  ```
  - âœ… **åº”è¯¥**ï¼šå¯¹äºæ¥å—é™é»˜æ¨¡å¼å‚æ•°ä½†è¿˜éœ€è¦æ£€æŸ¥å…¨å±€çŠ¶æ€çš„å‡½æ•°ï¼ˆè¾ƒå°‘è§ï¼‰ï¼š
  ```javascript
  // æ£€æŸ¥ä¼ é€’çš„å‚æ•°å’Œå…¨å±€é™é»˜æ¨¡å¼
  const isSilent = options.silentMode || (typeof options.silentMode === 'undefined' && isSilentMode());
  ```

## æ–‡ä»¶æ“ä½œï¼ˆåœ¨ `scripts/modules/utils.js` ä¸­ï¼‰

- **é”™è¯¯å¤„ç†**ï¼š
  - âœ… **åº”è¯¥**ï¼šä¸ºæ‰€æœ‰æ–‡ä»¶æ“ä½œä½¿ç”¨ try/catch å—ã€‚
  - âœ… **åº”è¯¥**ï¼šåœ¨å¤±è´¥æ—¶è¿”å› null æˆ–é»˜è®¤å€¼ã€‚
  - âœ… **åº”è¯¥**ï¼šä½¿ç”¨ `log` å®ç”¨å·¥å…·è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šå…è®¸å¼‚å¸¸ä»ç®€å•çš„æ–‡ä»¶è¯»å†™ä¸­æœªå¤„ç†åœ°ä¼ æ’­ã€‚

  ```javascript
  // âœ… **åº”è¯¥**ï¼šæ­£ç¡®å¤„ç†æ ¸å¿ƒå®ç”¨å·¥å…·ä¸­çš„æ–‡ä»¶æ“ä½œé”™è¯¯
  function writeJSON(filepath, data) {
    try {
      // ç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆç¤ºä¾‹ï¼‰
      const dir = path.dirname(filepath);
      if (!fs.existsSync(dir)) {
        fs.mkdirSync(dir, { recursive: true });
      }
      fs.writeFileSync(filepath, JSON.stringify(data, null, 2));
    } catch (error) {
      log('error', `å†™å…¥ JSON æ–‡ä»¶ ${filepath} æ—¶å‡ºé”™ï¼š`, error.message);
      if (CONFIG.debug) {
        console.error(error);
      }
    }
  }
  ```

## ä»»åŠ¡ç‰¹å®šå®ç”¨å·¥å…·ï¼ˆåœ¨ `scripts/modules/utils.js` ä¸­ï¼‰

- **ä»»åŠ¡ ID æ ¼å¼åŒ–**ï¼š
  - âœ… **åº”è¯¥**ï¼šåˆ›å»ºç”¨äºä¸€è‡´ ID å¤„ç†çš„å®ç”¨å·¥å…·ã€‚
  - âœ… **åº”è¯¥**ï¼šæ”¯æŒä¸åŒçš„ ID æ ¼å¼ï¼ˆæ•°å­—ã€å­—ç¬¦ä¸²ã€ç‚¹ç¬¦å·ï¼‰ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šåœ¨æ¨¡å—ä¹‹é—´é‡å¤æ ¼å¼åŒ–é€»è¾‘ã€‚

  ```javascript
  // âœ… **åº”è¯¥**ï¼šåˆ›å»ºç”¨äºå¸¸è§æ“ä½œçš„å®ç”¨å·¥å…·
  /**
   * å°†ä»»åŠ¡ ID æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
   * @param {string|number} id - è¦æ ¼å¼åŒ–çš„ä»»åŠ¡ ID
   * @returns {string} æ ¼å¼åŒ–çš„ä»»åŠ¡ ID
   */
  function formatTaskId(id) {
    if (typeof id === 'string' && id.includes('.')) {
      return id; // å·²ç»æ˜¯å¸¦æœ‰ç‚¹çš„å­—ç¬¦ä¸²æ ¼å¼ï¼ˆä¾‹å¦‚ "1.2"ï¼‰
    }
    
    if (typeof id === 'number') {
      return id.toString();
    }
    
    return id;
  }
  ```

- **ä»»åŠ¡æœç´¢**ï¼š
  - âœ… **åº”è¯¥**ï¼šå®ç°å¯å¤ç”¨çš„ä»»åŠ¡æŸ¥æ‰¾å®ç”¨å·¥å…·ã€‚
  - âœ… **åº”è¯¥**ï¼šæ”¯æŒä»»åŠ¡å’Œå­ä»»åŠ¡æŸ¥æ‰¾ã€‚
  - âœ… **åº”è¯¥**ï¼šä¸ºå­ä»»åŠ¡ç»“æœæ·»åŠ ä¸Šä¸‹æ–‡ã€‚

  ```javascript
  // âœ… **åº”è¯¥**ï¼šåˆ›å»ºå…¨é¢çš„æœç´¢å®ç”¨å·¥å…·
  /**
   * åœ¨ä»»åŠ¡æ•°ç»„ä¸­é€šè¿‡ ID æŸ¥æ‰¾ä»»åŠ¡
   * @param {Array} tasks - ä»»åŠ¡æ•°ç»„
   * @param {string|number} taskId - è¦æŸ¥æ‰¾çš„ä»»åŠ¡ ID
   * @returns {Object|null} ä»»åŠ¡å¯¹è±¡ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
   */
  function findTaskById(tasks, taskId) {
    if (!taskId || !tasks || !Array.isArray(tasks)) {
      return null;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å­ä»»åŠ¡ IDï¼ˆä¾‹å¦‚ "1.2"ï¼‰
    if (typeof taskId === 'string' && taskId.includes('.')) {
      const [parentId, subtaskId] = taskId.split('.').map(id => parseInt(id, 10));
      const parentTask = tasks.find(t => t.id === parentId);
      
      if (!parentTask || !parentTask.subtasks) {
        return null;
      }
      
      const subtask = parentTask.subtasks.find(st => st.id === subtaskId);
      if (subtask) {
        // ä¸ºå­ä»»åŠ¡æ·»åŠ çˆ¶ä»»åŠ¡å¼•ç”¨ä»¥æä¾›ä¸Šä¸‹æ–‡
        subtask.parentTask = { 
          id: parentTask.id, 
          title: parentTask.title,
          status: parentTask.status
        };
        subtask.isSubtask = true;
      }
      
      return subtask || null;
    }
    
    const id = parseInt(taskId, 10);
    return tasks.find(t => t.id === id) || null;
  }
  ```

## å¾ªç¯æ£€æµ‹ï¼ˆåœ¨ `scripts/modules/utils.js` ä¸­ï¼‰

- **å›¾ç®—æ³•**ï¼š
  - âœ… **åº”è¯¥**ï¼šä½¿ç”¨å›¾éå†å®ç°å¾ªç¯æ£€æµ‹ã€‚
  - âœ… **åº”è¯¥**ï¼šè·Ÿè¸ªå·²è®¿é—®èŠ‚ç‚¹å’Œé€’å½’å †æ ˆã€‚
  - âœ… **åº”è¯¥**ï¼šè¿”å›æœ‰å…³å¾ªç¯çš„å…·ä½“ä¿¡æ¯ã€‚

  ```javascript
  // âœ… **åº”è¯¥**ï¼šæ­£ç¡®å®ç°å¾ªç¯æ£€æµ‹
  /**
   * ä½¿ç”¨ DFS åœ¨ä¾èµ–å›¾ä¸­æŸ¥æ‰¾å¾ªç¯
   * @param {string} subtaskId - å½“å‰å­ä»»åŠ¡ ID
   * @param {Map} dependencyMap - å­ä»»åŠ¡ ID åˆ°å…¶ä¾èµ–é¡¹çš„æ˜ å°„
   * @param {Set} visited - å·²è®¿é—®èŠ‚ç‚¹çš„é›†åˆ
   * @param {Set} recursionStack - å½“å‰é€’å½’å †æ ˆä¸­çš„èŠ‚ç‚¹é›†åˆ
   * @param {Array} path - å½“å‰è·¯å¾„
   * @returns {Array} - éœ€è¦ç§»é™¤ä»¥æ‰“ç ´å¾ªç¯çš„ä¾èµ–è¾¹åˆ—è¡¨
   */
  function findCycles(subtaskId, dependencyMap, visited = new Set(), recursionStack = new Set(), path = []) {
    // å°†å½“å‰èŠ‚ç‚¹æ ‡è®°ä¸ºå·²è®¿é—®å¹¶åŠ å…¥é€’å½’å †æ ˆ
    visited.add(subtaskId);
    recursionStack.add(subtaskId);
    path.push(subtaskId);
    
    const cyclesToBreak = [];
    
    // è·å–å½“å‰å­ä»»åŠ¡çš„æ‰€æœ‰ä¾èµ–é¡¹
    const dependencies = dependencyMap.get(subtaskId) || [];
    
    // éå†æ¯ä¸ªä¾èµ–é¡¹
    for (const depId of dependencies) {
      // å¦‚æœæœªè®¿é—®ï¼Œåˆ™é€’å½’æ£€æŸ¥å¾ªç¯
      if (!visited.has(depId)) {
        const cycles = findCycles(depId, dependencyMap, visited, recursionStack, [...path]);
        cyclesToBreak.push(...cycles);
      } 
      // å¦‚æœä¾èµ–é¡¹åœ¨é€’å½’å †æ ˆä¸­ï¼Œåˆ™æ‰¾åˆ°å¾ªç¯
      else if (recursionStack.has(depId)) {
        // å¾ªç¯ä¸­çš„æœ€åä¸€ä¸ªè¾¹æ˜¯æˆ‘ä»¬æƒ³è¦ç§»é™¤çš„
        cyclesToBreak.push(depId);
      }
    }
    
    // åœ¨è¿”å›å‰ä»é€’å½’å †æ ˆä¸­ç§»é™¤èŠ‚ç‚¹
    recursionStack.delete(subtaskId);
    
    return cyclesToBreak;
  }
  ```

## MCP æœåŠ¡å™¨æ ¸å¿ƒå®ç”¨å·¥å…·ï¼ˆ`mcp-server/src/core/utils/`ï¼‰

### é¡¹ç›®æ ¹ç›®å½•å’Œä»»åŠ¡æ–‡ä»¶è·¯å¾„æ£€æµ‹ï¼ˆ`path-utils.js`ï¼‰

- **ç›®çš„**ï¼šæ­¤æ¨¡å— ([mcp-server/src/core/utils/path-utils.js](mdc:mcp-server/src/core/utils/path-utils.js)) æä¾›äº†å®šä½ç”¨æˆ· `tasks.json` æ–‡ä»¶çš„æœºåˆ¶ï¼Œä¾›ç›´æ¥å‡½æ•°ä½¿ç”¨ã€‚
- **`findTasksJsonPath(args, log)`**ï¼š
    - âœ… **åº”è¯¥**ï¼šä» **ç›´æ¥å‡½æ•°åŒ…è£…å™¨**ï¼ˆä¾‹å¦‚ `mcp-server/src/core/direct-functions/` ä¸­çš„ `listTasksDirect`ï¼‰ä¸­è°ƒç”¨æ­¤å‡½æ•°ï¼Œä»¥è·å–ç›¸å…³ `tasks.json` çš„ç»å¯¹è·¯å¾„ã€‚
    - ä¼ é€’ MCP å·¥å…·æ¥æ”¶åˆ°çš„æ•´ä¸ª `args` å¯¹è±¡ï¼ˆåº”åŒ…å«ä»ä¼šè¯æ´¾ç”Ÿçš„ `projectRoot`ï¼‰å’Œ `log` å¯¹è±¡ã€‚
    - å®ç°äº†ç”¨äºæŸ¥æ‰¾ `tasks.json` è·¯å¾„çš„ **ç®€åŒ–ä¼˜å…ˆçº§ç³»ç»Ÿ**ï¼š
        1. æ˜ç¡®ä¼ é€’ç»™ `args` çš„ `projectRoot`ï¼ˆMCP å·¥å…·é¢„æœŸï¼‰ã€‚
        2. ç¼“å­˜çš„ `lastFoundProjectRoot`ï¼ˆCLI å›é€€ï¼‰ã€‚
        3. ä» `process.cwd()` å‘ä¸Šæœç´¢ï¼ˆCLI å›é€€ï¼‰ã€‚
    - å¦‚æœæ— æ³•å®šä½ `tasks.json` æ–‡ä»¶ï¼Œåˆ™æŠ›å‡ºç‰¹å®šé”™è¯¯ã€‚
    - åœ¨æˆåŠŸæ—¶æ›´æ–° `lastFoundProjectRoot` ç¼“å­˜ã€‚
- **`PROJECT_MARKERS`**ï¼šå¯¼å‡ºçš„æ•°ç»„ï¼ŒåŒ…å«åœ¨ CLI å›é€€æœç´¢æœŸé—´ç”¨äºè¯†åˆ«å¯èƒ½é¡¹ç›®æ ¹ç›®å½•çš„å¸¸è§æ–‡ä»¶/ç›®å½•åç§°ã€‚
- **`getPackagePath()`**ï¼šç”¨äºæŸ¥æ‰¾ `task-master-ai` åŒ…æœ¬èº«å®‰è£…è·¯å¾„çš„å®ç”¨å·¥å…·ï¼ˆå¯èƒ½å¯ç§»é™¤ï¼‰ã€‚

## MCP æœåŠ¡å™¨å·¥å…·å®ç”¨å·¥å…·ï¼ˆ`mcp-server/src/tools/utils.js`ï¼‰

è¿™äº›å®ç”¨å·¥å…·ä¸“é—¨æ”¯æŒ MCP å·¥å…·çš„å®ç°å’Œæ‰§è¡Œã€‚

- **`normalizeProjectRoot(rawPath, log)`**ï¼š
    - **ç›®çš„**ï¼šæ¥å—åŸå§‹é¡¹ç›®æ ¹è·¯å¾„ï¼ˆå¯èƒ½ URI ç¼–ç ï¼Œå¸¦æœ‰ `file://` å‰ç¼€ï¼ŒWindows æ–œæ ï¼‰å¹¶è¿”å›é€‚åˆæœåŠ¡å™¨æ“ä½œç³»ç»Ÿçš„è§„èŒƒåŒ–ç»å¯¹è·¯å¾„ã€‚
    - **é€»è¾‘**ï¼šè§£ç  URIï¼Œç§»é™¤ `file://`ï¼Œå¤„ç† Windows é©±åŠ¨å™¨å‰ç¼€ï¼ˆ`/C:/`ï¼‰ï¼Œå°† `\` æ›¿æ¢ä¸º `/`ï¼Œä½¿ç”¨ `path.resolve()`ã€‚
    - **ä½¿ç”¨**ï¼šç”± `withNormalizedProjectRoot` é«˜é˜¶å‡½æ•°ï¼ˆHOFï¼‰å†…éƒ¨ä½¿ç”¨ã€‚

- **`getRawProjectRootFromSession(session, log)`**ï¼š
    - **ç›®çš„**ï¼šä»ä¼šè¯å¯¹è±¡ï¼ˆ`session.roots[0].uri` æˆ– `session.roots.roots[0].uri`ï¼‰ä¸­æå– *åŸå§‹* é¡¹ç›®æ ¹ URI å­—ç¬¦ä¸²ï¼Œè€Œä¸è¿›è¡Œè§„èŒƒåŒ–ã€‚
    - **ä½¿ç”¨**ï¼šç”± `withNormalizedProjectRoot` HOF å†…éƒ¨ä½¿ç”¨ï¼Œä½œä¸º `args.projectRoot` æœªæä¾›æ—¶çš„å›é€€ã€‚

- **`withNormalizedProjectRoot(executeFn)`**ï¼š
    - **ç›®çš„**ï¼šè®¾è®¡ç”¨äºåŒ…è£…å·¥å…·çš„ `execute` æ–¹æ³•çš„é«˜é˜¶å‡½æ•°ï¼ˆHOFï¼‰ã€‚
    - **é€»è¾‘**ï¼š 
        1. ç¡®å®šåŸå§‹é¡¹ç›®æ ¹ï¼ˆæ¥è‡ª `args.projectRoot` æˆ– `getRawProjectRootFromSession`ï¼‰ã€‚
        2. ä½¿ç”¨ `normalizeProjectRoot` è§„èŒƒåŒ–åŸå§‹è·¯å¾„ã€‚
        3. å°†è§„èŒƒåŒ–åçš„ç»å¯¹è·¯å¾„é‡æ–°æ³¨å…¥åˆ° `args` å¯¹è±¡ä¸­ä½œä¸º `args.projectRoot`ã€‚
        4. ä½¿ç”¨æ›´æ–°åçš„ `args` è°ƒç”¨åŸå§‹ `executeFn`ã€‚
    - **ä½¿ç”¨**ï¼šåº”åŒ…è£…æ¯ä¸ªéœ€è¦å¯é ã€è§„èŒƒåŒ–é¡¹ç›®æ ¹è·¯å¾„çš„ MCP å·¥å…·çš„ `execute` å‡½æ•°ã€‚
    - **ç¤ºä¾‹**ï¼š
      ```javascript
      // åœ¨ mcp-server/src/tools/your-tool.js ä¸­
      import { withNormalizedProjectRoot } from './utils.js';
      
      export function registerYourTool(server) {
          server.addTool({
              // ... name, description, parameters ...
              execute: withNormalizedProjectRoot(async (args, context) => {
                  // args.projectRoot åœ¨æ­¤å¤„å·²è§„èŒƒåŒ–
                  const { projectRoot /*, other args */ } = args;
                  // ... ä½¿ç”¨è§„èŒƒåŒ– projectRoot çš„å·¥å…·é€»è¾‘ ...
              })
          });
      }
      ```

- **`handleApiResult(result, log, errorPrefix, processFunction)`**ï¼š
    - **ç›®çš„**ï¼šå°†ç›´æ¥å‡½æ•°è¿”å›çš„å“åº”ï¼ˆ`{ success, data/error, fromCache }`ï¼‰æ ¼å¼åŒ–ä¸º MCP å“åº”æ ¼å¼ã€‚
    - **ä½¿ç”¨**ï¼šåœ¨å·¥å…·çš„ `execute` æ–¹æ³•æœ«å°¾è°ƒç”¨ï¼Œä¼ é€’ç›´æ¥å‡½æ•°è°ƒç”¨çš„ç»“æœã€‚

- **`createContentResponse(content)`** / **`createErrorResponse(errorMessage)`**ï¼š
    - **ç›®çš„**ï¼šåˆ›å»ºç”¨äºæˆåŠŸæˆ–é”™è¯¯æ¶ˆæ¯çš„åŸºæœ¬ MCP å“åº”ç»“æ„çš„è¾…åŠ©å‡½æ•°ã€‚
    - **ä½¿ç”¨**ï¼šç”± `handleApiResult` å†…éƒ¨ä½¿ç”¨ï¼Œä¹Ÿå¯ç›´æ¥ç”¨äºç®€å•å“åº”ã€‚

- **`createLogWrapper(log)`**ï¼š
    - **ç›®çš„**ï¼šåˆ›å»ºä¸€ä¸ªå…·æœ‰æ ‡å‡†æ–¹æ³•ï¼ˆ`info`ã€`warn`ã€`error`ã€`debug`ã€`success`ï¼‰çš„æ—¥å¿—è®°å½•å™¨å¯¹è±¡åŒ…è£…å™¨ï¼Œæ˜ å°„åˆ°ä¼ é€’çš„ MCP `log` å¯¹è±¡çš„æ–¹æ³•ã€‚ç¡®ä¿åœ¨ä¼ é€’æ—¥å¿—è®°å½•å™¨åˆ°æ ¸å¿ƒå‡½æ•°æ—¶çš„å…¼å®¹æ€§ã€‚
    - **ä½¿ç”¨**ï¼šåœ¨ç›´æ¥å‡½æ•°ä¸­ä¼ é€’ `log` å¯¹è±¡ä¹‹å‰ä½¿ç”¨ã€‚

- **`getCachedOrExecute({ cacheKey, actionFn, log })`**ï¼š
    - **ç›®çš„**ï¼šç”¨äºåœ¨ç›´æ¥å‡½æ•°ä¸­å®ç°ç¼“å­˜çš„å®ç”¨å·¥å…·ã€‚æ£€æŸ¥ç¼“å­˜ä¸­çš„ `cacheKey`ï¼›å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™æ‰§è¡Œ `actionFn`ï¼Œç¼“å­˜æˆåŠŸç»“æœå¹¶è¿”å›ã€‚
    - **ä½¿ç”¨**ï¼šåœ¨ç›´æ¥å‡½æ•°è°ƒç”¨ä¸­åŒ…è£…æ ¸å¿ƒé€»è¾‘æ‰§è¡Œã€‚

- **`processMCPResponseData(taskOrData, fieldsToRemove)`**ï¼š
    - **ç›®çš„**ï¼šåœ¨é€šè¿‡ MCP å‘é€å“åº”ä¹‹å‰ï¼Œä»ä»»åŠ¡å¯¹è±¡ä¸­è¿‡æ»¤å¯èƒ½æ•æ„Ÿæˆ–è¾ƒå¤§çš„å­—æ®µï¼ˆå¦‚ `details`ã€`testStrategy`ï¼‰çš„å®ç”¨å·¥å…·ã€‚
    - **ä½¿ç”¨**ï¼šä½œä¸ºé»˜è®¤ `processFunction` ä¼ é€’ç»™ `handleApiResult`ã€‚

- **`getProjectRootFromSession(session, log)`**ï¼š
    - **ç›®çš„**ï¼šæå– *å¹¶è§„èŒƒåŒ–* ä¼šè¯ä¸­çš„é¡¹ç›®æ ¹ç›®å½•çš„é—ç•™å‡½æ•°ã€‚è¢« HOF æ¨¡å¼å–ä»£ï¼Œä½†å¯èƒ½ä»è¢«ç›´æ¥ä½¿ç”¨ã€‚
    - **å»ºè®®**ï¼šåœ¨å·¥å…·ä¸­ä¼˜å…ˆä½¿ç”¨ `withNormalizedProjectRoot` HOFï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨æ­¤å‡½æ•°ã€‚

- **`executeTaskMasterCommand(...)`**ï¼š 
    - **ç›®çš„**ï¼šä½œä¸ºå›é€€æ‰§è¡Œ `task-master` CLI å‘½ä»¤ã€‚
    - **å»ºè®®**ï¼šå¤§å¤šæ•°ç”¨é€”å·²åºŸå¼ƒï¼Œä¼˜å…ˆä½¿ç”¨ç›´æ¥å‡½æ•°è°ƒç”¨ã€‚

## å¯¼å‡ºç»„ç»‡

- **æŒ‰ç›¸å…³æ€§åˆ†ç»„å‡½æ•°**ï¼š
  - âœ… **åº”è¯¥**ï¼šå°†ä¸ä½ç½®ç›¸å…³çš„å®ç”¨å·¥å…·ä¿æŒåœ¨ä¸€èµ·ï¼ˆä¾‹å¦‚ï¼Œæ ¸å¿ƒ CLI å®ç”¨å·¥å…·åœ¨ `scripts/modules/utils.js` ä¸­ï¼ŒMCP è·¯å¾„å®ç”¨å·¥å…·åœ¨ `mcp-server/src/core/utils/path-utils.js` ä¸­ï¼ŒMCP å·¥å…·å®ç”¨å·¥å…·åœ¨ `mcp-server/src/tools/utils.js` ä¸­ï¼‰ã€‚
  - âœ… **åº”è¯¥**ï¼šæ¯ä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨å•æ¡è¯­å¥å¯¼å‡ºæ‰€æœ‰å®ç”¨å·¥å…·å‡½æ•°ã€‚
  - âœ… **åº”è¯¥**ï¼šå°†ç›¸å…³å¯¼å‡ºåˆ†ç»„ã€‚
  - âœ… **åº”è¯¥**ï¼šå¯¼å‡ºé…ç½®å¸¸é‡ï¼ˆæ¥è‡ª `scripts/modules/utils.js`ï¼‰ã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šä½¿ç”¨é»˜è®¤å¯¼å‡ºã€‚
  - âŒ **ä¸åº”è¯¥**ï¼šåˆ›å»ºå¾ªç¯ä¾èµ–ï¼ˆå‚è§ [architecture.mdc](mdc:.cursor/rules/architecture.mdc)ï¼‰ã€‚

```javascript
// ç¤ºä¾‹ï¼šæ¥è‡ª scripts/modules/utils.js çš„å¯¼å‡º
export {
  // é…ç½®
  CONFIG,
  LOG_LEVELS,
  
  // æ—¥å¿—
  log,
  
  // æ–‡ä»¶æ“ä½œ
  readJSON,
  writeJSON,
  
  // å­—ç¬¦ä¸²æ“ä½œ
  sanitizePrompt,
  truncate,
  
  // ä»»åŠ¡å®ç”¨å·¥å…·
  // ... (taskExists, formatTaskId, findTaskById, ç­‰ç­‰)
  
  // å›¾ç®—æ³•
  findCycles,
};

// ç¤ºä¾‹ï¼šæ¥è‡ª mcp-server/src/core/utils/path-utils.js çš„å¯¼å‡º
export {
  findTasksJsonPath,
  getPackagePath,
  PROJECT_MARKERS,
  lastFoundProjectRoot // å¦‚æœéœ€è¦ç›´æ¥ä½¿ç”¨/é‡ç½®ï¼Œå¯¼å‡ºä»¥ä¾›ä½¿ç”¨
};

// ç¤ºä¾‹ï¼šæ¥è‡ª mcp-server/src/tools/utils.js çš„å¯¼å‡º
export {
  getProjectRoot,
  getProjectRootFromSession,
  handleApiResult,
  executeTaskMasterCommand,
  processMCPResponseData,
  createContentResponse,
  createErrorResponse,
  getCachedOrExecute
};
```

æœ‰å…³ MCP æœåŠ¡å™¨æ¶æ„å’Œé›†æˆçš„æ›´å¤šä¸Šä¸‹æ–‡ï¼Œè¯·å‚é˜… [mcp.mdc](mdc:.cursor/rules/mcp.mdc) å’Œ [architecture.mdc](mdc:.cursor/rules/architecture.mdc)ã€‚